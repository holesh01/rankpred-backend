<!DOCTYPE html>
<html>
<head>
  <title>Evaluate | RankPred</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h1 id="examTitle">Evaluation</h1>
</header>

<div class="container">

  <button onclick="goBack()">⬅ Back</button>
   <h2>Response Sheet</h2>
  
  <!-- NEW: DIGIALM URL -->
  <input
    type="text"
    id="resultUrl"
    placeholder="Paste DigiALM result link">
    <!-- <p style="margin:8px 0; font-weight:bold;">OR</p> -->

  <!-- FILE UPLOAD (OLD, UNCHANGED) -->
  <!-- <input type="file" id="responseFile" accept=".html"> -->


  

  <h2>Candidate Details</h2>

  

  <select id="category">
    <option value="">Select Category</option>
    <option>UR</option>
    <option>EWS</option>
    <option>OBC</option>
    <option>SC</option>
    <option>ST</option>
  </select>

  <select id="gender">
    <option value="">Select Gender</option>
    <option>Male</option>
    <option>Female</option>
  </select>

  <select id="state">
    <option value="">Select State / UT</option>
    <option>Andhra Pradesh</option>
    <option>Arunachal Pradesh</option>
    <option>Assam</option>
    <option>Bihar</option>
    <option>Chhattisgarh</option>
    <option>Delhi</option>
    <option>Gujarat</option>
    <option>Haryana</option>
    <option>Karnataka</option>
    <option>Maharashtra</option>
    <option>Rajasthan</option>
    <option>Tamil Nadu</option>
    <option>Uttar Pradesh</option>
    <option>West Bengal</option>
    <option>Jammu and Kashmir</option>
    <option>Ladakh</option>
    <option>Puducherry</option>
  </select>

 

  <br><br>
  <button onclick="evaluateFromClient()">Evaluate</button>

  <p id="status"></p>

</div>

<script>
const API_BASE = "https://rankpred-backend-1.onrender.com";

async function evaluateFromClient() {
  const url = document.getElementById("responseUrl").value.trim();
  const exam_name = localStorage.getItem("selectedExam");
  const category = document.getElementById("category").value;
  const gender = document.getElementById("gender").value;
  const state = document.getElementById("state").value;

  if (!url) {
    alert("Paste DigiALM response sheet URL");
    return;
  }

  try {
    // ✅ FETCH DIGIALM FROM USER BROWSER (IMPORTANT)
    const res = await fetch(url, {
      credentials: "include" // must be logged in
    });

    if (!res.ok) {
      throw new Error("Fetch blocked");
    }

    const html = await res.text();

    // ✅ SEND RAW HTML TO BACKEND
    const apiRes = await fetch(`${API_BASE}/evaluate-html`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        exam_name,
        category,
        gender,
        state,
        html
      })
    });

    const data = await apiRes.json();

    if (data.error) {
      alert(data.error);
      return;
    }

    // redirect to result page
    window.location.href =
      `result.html?exam=${encodeURIComponent(exam_name)}&roll=${encodeURIComponent(data.roll)}`;

  } catch (err) {
    alert(
      "Unable to fetch DigiALM page.\n\n" +
      "Make sure:\n" +
      "1. You are logged into DigiALM\n" +
      "2. The link opens in the same browser"
    );
  }
}
</script>

</body>
</html>
